<!DOCTYPE html>
<html>
<head>
    <title>PNL Tools - Loading...</title>
    <link rel="icon" href="/static/computer.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .loading-window {
            max-width: 500px;
            margin: 100px auto;
        }
        
        .loading-content {
            text-align: center;
            padding: 40px 20px;
        }
        
        .dial-up-container {
            display: inline-block;
            padding: 20px;
            background-color: #008080;
            margin-bottom: 20px;
        }
        
        .dial-up-gif {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            background-color: #ffffff;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            width: 30%;
            background-color: #000080;
            position: absolute;
            animation: slide 1.5s linear infinite;
        }
        
        @keyframes slide {
            0% { left: -30%; }
            100% { left: 100%; }
        }
        
        .status-text {
            margin: 15px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="window loading-window">
        <div class="title-bar">
            <div class="title-bar-text">Processing Request...</div>
        </div>
        <div class="window-body">
            <div class="loading-content">
                <div class="dial-up-container">
                    <img src="/static/internet-dial-up.gif" alt="Connecting..." class="dial-up-gif">
                </div>
                <div class="status-text" id="status">Loading PnL data...</div>
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
                <div style="margin-top: 20px; font-size: 11px; color: #666;">
                    Please wait while we fetch your data from the exchange...
                </div>
            </div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        
        // Prepare form data from template variables
        const formData = new URLSearchParams({
            api_key: '{{ api_key }}',
            api_secret: '{{ api_secret }}',
            start_datetime: '{{ start_datetime }}',
            end_datetime: '{{ end_datetime }}',
            symbols: '{{ symbols }}',
            chart_type: '{{ chart_type }}',
            action: '{{ action }}'
        });
        
        // Simulate progress updates
        const statuses = [
            'Connecting to exchange...',
            'Fetching PnL data...',
            'Loading executions...',
            'Loading transfers and deposits...',
            'Processing data...',
            'Generating charts...'
        ];
        
        let statusIndex = 0;
        const statusInterval = setInterval(() => {
            if (statusIndex < statuses.length) {
                statusEl.textContent = statuses[statusIndex];
                statusIndex++;
            }
        }, 1500);
        
        // Make actual request
        fetch('/process_async', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData.toString()
        })
        .then(response => response.text())
        .then(html => {
            clearInterval(statusInterval);
            // Replace entire page with results
            document.open();
            document.write(html);
            document.close();
        })
        .catch(error => {
            clearInterval(statusInterval);
            statusEl.textContent = 'Error: ' + error.message;
            statusEl.style.color = 'red';
        });
    </script>
</body>
</html>
